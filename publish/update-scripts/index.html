<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <meta name="author" content="Team <teamname>">
  <link rel="shortcut icon" href="../../img/favicon.ico">
  <title>How make updating your tool easy? - Development manual</title>
  <link href='https://fonts.googleapis.com/css?family=Lato:400,700|Roboto+Slab:400,700|Inconsolata:400,700' rel='stylesheet' type='text/css'>

  <link rel="stylesheet" href="../../css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../css/theme_extra.css" type="text/css" />
  <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/github.min.css">
  
  <script>
    // Current page data
    var mkdocs_page_name = "How make updating your tool easy?";
    var mkdocs_page_input_path = "publish/update-scripts.md";
    var mkdocs_page_url = "/development/publish/update-scripts/";
  </script>
  
  <script src="../../js/jquery-2.1.1.min.js" defer></script>
  <script src="../../js/modernizr-2.8.3.min.js" defer></script>
  <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
  <script>hljs.initHighlightingOnLoad();</script> 
  
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
      <div class="wy-side-nav-search">
        <a href="../.." class="icon icon-home"> Development manual</a>
        <div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
	<ul class="current">
	  
          
            <li class="toctree-l1">
		
    <a class="" href="../..">Home</a>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">How do confine my project?</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../../conda/conda_conventions/">How to name your conda env</a>
                </li>
                <li class="">
                    
    <a class="" href="../../conda/activate/">How do I activate an env?</a>
                </li>
                <li class="">
                    
    <a class="" href="../../perl/installation/perlbrew/">How do I manage perl and cpanm?</a>
                </li>
    </ul>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../../editors/">Choose your editor :)</a>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">How do we use Python?</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../../python/conventions/">conventions</a>
                </li>
                <li class="">
                    
    <a class="" href="../../python/variables/">variables</a>
                </li>
                <li class="">
                    
    <a class="" href="../../python/logging/">logging</a>
                </li>
                <li class="">
                    
    <span class="caption-text">How to write unit tests?</span>
    <ul class="subnav">
                <li class="toctree-l3">
                    
    <a class="" href="../../python/testing/">GIVEN-WHEN-THEN</a>
                </li>
                <li class="toctree-l3">
                    
    <a class="" href="../../python/testing/fixtures/">Are you using fixtures?</a>
                </li>
    </ul>
                </li>
    </ul>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">How to publish your tool?</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../crontab/">How to automate running your tool?</a>
                </li>
                <li class=" current">
                    
    <a class="current" href="./">How make updating your tool easy?</a>
    <ul class="subnav">
            
    <li class="toctree-l3"><a href="#how-to-easily-update-your-tool">How to easily update your tool?</a></li>
    
        <ul>
        
            <li><a class="toctree-l4" href="#stage-cli-update-script">Stage CLI update script</a></li>
        
            <li><a class="toctree-l4" href="#naming-of-scripts">Naming of scripts</a></li>
        
            <li><a class="toctree-l4" href="#what-about-config-files">What about config files?</a></li>
        
            <li><a class="toctree-l4" href="#what-about-databases">What about databases?</a></li>
        
            <li><a class="toctree-l4" href="#so-what-is-beta">So, what is beta?</a></li>
        
        </ul>
    

    </ul>
                </li>
    </ul>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">Other recommendations?</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../../perl/">What if I need perl?</a>
                </li>
                <li class="">
                    
    <a class="" href="../../perl/best_practises/best_practises/">What are perl's best practices?</a>
                </li>
    </ul>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../../mkdocs/">How do I publish this manual?</a>
	    </li>
          
        </ul>
      </div>
      &nbsp;
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="../..">Development manual</a>
      </nav>

      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../..">Docs</a> &raquo;</li>
    
      
        
          <li>How to publish your tool? &raquo;</li>
        
      
    
    <li>How make updating your tool easy?</li>
    <li class="wy-breadcrumbs-aside">
      
        <a href="https://github.com/Clinical-Genomics/development/edit/master/docs/publish/update-scripts.md"
          class="icon icon-github"> Edit on GitHub</a>
      
    </li>
  </ul>
  <hr/>
</div>
          <div role="main">
            <div class="section">
              
                <h1 id="how-to-easily-update-your-tool">How to easily update your tool?</h1>
<p>You will want to create two scripts, at least:</p>
<ul>
<li>one to update your tool on stage</li>
<li>one to update your tool on prod</li>
</ul>
<p>Yes, I just wrote that out in full. It's that important!</p>
<h2 id="stage-cli-update-script">Stage CLI update script</h2>
<p>How does such a script look like. Well, let's have a look at one that closest resembles a template, <code>update-trailblazer-stage.sh</code></p>
<pre><code class="bash">#!/usr/bin/env bash

# exit on error
set -e

# make sure we run as hiseq.clinical
sh ./assert_user.sh hiseq.clinical

# make sure we run on rasta. Leave this assert out if this script can be run on all servers.
sh ./assert_host.sh rastapopoulos.scilifelab.se

# One optional argument
BRANCH=${1}

# make sure we can have access to aliases
shopt -s expand_aliases

# make sure we are closely resembling production
source ~/.bashrc

# go to stage. Yes, this conda env should already exist
source activate stage

# install with latest changes on &quot;master&quot;
pip install -U git+https://github.com/Clinical-Genomics/trailblazer@$BRANCH
</code></pre>

<p>You run it:</p>
<pre><code class="bash">cd ~/servers/resources
sh update-trailblazer-stage.sh
</code></pre>

<p>Or you update stage to a specific branch:</p>
<pre><code class="bash">cd ~/servers/resources
sh update-trailblazer-stage.sh beta
</code></pre>

<h3 id="web-update-script">Web update script</h3>
<p>For web frontend, one can add everything you need to update a staging env:</p>
<pre><code class="bash">#!/usr/bin/env bash

# exit on error
set -e

# make sure we run as hiseq.clinical
sh ./assert_user.sh hiseq.clinical

# make sure we run on clinical-db
sh ./assert_host.sh clinical-db.scilifelab.se

# One optional argument, prefilled
BRANCH=${1-master}

# make sure we can have access to aliases
shopt -s expand_aliases

# make sure we are closely resembling production
source ~/.bashrc

# go to stage. Yes, this conda env should already exist
source activate stage

# trailblazer-stage is already installed in a predefined location. The repo should already be cloned
cd ~/STAGE/trailblazer

# Update!
git fetch
git checkout $BRANCH
git pull

# install and update pip dependencies
pip install -U --editable .

# restart the Flask service
supervisorctl restart trailblazer-stage
supervisorctl restart trailblazer-api-stage

# Drop you back to the initial directory
cd -
</code></pre>

<h2 id="naming-of-scripts">Naming of scripts</h2>
<p>The suggestion is to name your script: <code>update-$component-stage.sh</code></p>
<p>with $component the name of your component, be it <code>trailblazer</code> for the cli or <code>trailblazer-ui</code> for the web.</p>
<h2 id="what-about-config-files">What about config files?</h2>
<p>Premade config files for all packages used in production and stage have been made in the <code>config</code> dir of the servers repo. This can be found on rasta and clinical-db in the same location:</p>
<pre><code>cd ~/servers/config
</code></pre>

<p>All config files point to the stage location of the package, if any, to lims-stage, and to the staging databases.</p>
<h2 id="what-about-databases">What about databases?</h2>
<h3 id="mysql">MySQL</h3>
<p>All databases are located on clinical-db. To make sure you have the latest uncorrupted data, you can make a copy of one or all databases like this:</p>
<p>On clinical-db, copying all databases:</p>
<pre><code>cd ~/servers/resources
bash dbcopy-prod-to-stage.sh
</code></pre>

<p>On clinical-db, copy one database:</p>
<pre><code>cd ~/servers/resources
bash dbcopy-prod-to-stage.sh trailblazer
</code></pre>

<p>The credentials to the stage databases have already been set in the stage configs.</p>
<h3 id="mongo">Mongo</h3>
<p>All mongodbs are located on clinical-db. To copy both scout and loqusdb, you can issue:</p>
<pre><code>cd ~/servers/resources
bash dbcopy-mongoprod-to-stage.sh
</code></pre>

<p>This will reinstate a backuped version of scout (dated: 2018-05-18) and a fresh copy of loqusdb.</p>
<p>Please be aware that this process takes several days to complete!</p>
<p>The mongo-stage server is not running by default. To start the mongo-stage run:</p>
<pre><code>cd ~/servers/resources
bash start-mongo-stage.sh &amp;
</code></pre>

<h2 id="so-what-is-beta">So, what is beta?</h2>
<p>The beta environment, for now, is not an environment at all. It is a bunch of branches in git for cg and trailblazer that are affected by the MIP6/Scout4 update.</p>
<p>To update stage to use those branches, run</p>
<p>Rasta:</p>
<pre><code>bash update-beta.sh
</code></pre>
              
            </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../../perl/" class="btn btn-neutral float-right" title="What if I need perl?">Next <span class="icon icon-circle-arrow-right"></span></a>
      
      
        <a href="../crontab/" class="btn btn-neutral" title="How to automate running your tool?"><span class="icon icon-circle-arrow-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
    
  </div>

  Built with <a href="http://www.mkdocs.org">MkDocs</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
      
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" style="cursor: pointer">
    <span class="rst-current-version" data-toggle="rst-current-version">
      
          <a href="https://github.com/Clinical-Genomics/development/" class="fa fa-github" style="float: left; color: #fcfcfc"> GitHub</a>
      
      
        <span><a href="../crontab/" style="color: #fcfcfc;">&laquo; Previous</a></span>
      
      
        <span style="margin-left: 15px"><a href="../../perl/" style="color: #fcfcfc">Next &raquo;</a></span>
      
    </span>
</div>
    <script>var base_url = '../..';</script>
    <script src="../../js/theme.js" defer></script>
      <script src="../../search/main.js" defer></script>

</body>
</html>
