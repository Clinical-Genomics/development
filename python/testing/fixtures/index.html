<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <meta name="author" content="Team <teamname>">
  <link rel="shortcut icon" href="../../../img/favicon.ico">
  <title>Are you using fixtures? - Development manual</title>
  <link href='https://fonts.googleapis.com/css?family=Lato:400,700|Roboto+Slab:400,700|Inconsolata:400,700' rel='stylesheet' type='text/css'>

  <link rel="stylesheet" href="../../../css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../css/theme_extra.css" type="text/css" />
  <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/github.min.css">
  
  <script>
    // Current page data
    var mkdocs_page_name = "Are you using fixtures?";
    var mkdocs_page_input_path = "python/testing/fixtures.md";
    var mkdocs_page_url = "/development/python/testing/fixtures/";
  </script>
  
  <script src="../../../js/jquery-2.1.1.min.js" defer></script>
  <script src="../../../js/modernizr-2.8.3.min.js" defer></script>
  <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
  <script>hljs.initHighlightingOnLoad();</script> 
  
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
      <div class="wy-side-nav-search">
        <a href="../../.." class="icon icon-home"> Development manual</a>
        <div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
	<ul class="current">
	  
          
            <li class="toctree-l1">
		
    <a class="" href="../../..">Home</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../../../tools/">What are the commonly used tools?</a>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">Choose a development workflow</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../../../dev/models/">Overview</a>
                </li>
                <li class="">
                    
    <a class="" href="../../../dev/githubflow/">github flow</a>
                </li>
                <li class="">
                    
    <a class="" href="../../../dev/gitflow/">git flow</a>
                </li>
    </ul>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">How do confine my project?</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../../../conda/conda_conventions/">How to name your conda env</a>
                </li>
                <li class="">
                    
    <a class="" href="../../../conda/activate/">How do I activate an env?</a>
                </li>
                <li class="">
                    
    <a class="" href="../../../perl/installation/perlbrew/">How do I manage perl and cpanm?</a>
                </li>
    </ul>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../../../editors/">Choose your editor :)</a>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">How do we use Python?</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../../conventions/">conventions</a>
                </li>
                <li class="">
                    
    <a class="" href="../../variables/">variables</a>
                </li>
                <li class="">
                    
    <a class="" href="../../logging/">logging</a>
                </li>
                <li class=" current">
                    
    <span class="caption-text">How to write unit tests?</span>
    <ul class="subnav">
                <li class="toctree-l3">
                    
    <a class="" href="../">GIVEN-WHEN-THEN</a>
                </li>
                <li class="toctree-l3 current">
                    
    <a class="current" href="./">Are you using fixtures?</a>
    <ul class="subnav">
            
    <li class="toctree-l4"><a href="#fixtures-and-pytest">Fixtures (and pytest)</a></li>
    
        <ul>
        
            <li><a class="toctree-l5" href="#organizing-tests">Organizing tests</a></li>
        
            <li><a class="toctree-l5" href="#test-fixtures">Test fixtures</a></li>
        
        </ul>
    

    </ul>
                </li>
    </ul>
                </li>
    </ul>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">How to publish your tool?</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../../../publish/prod/">How to publish your tool?</a>
                </li>
                <li class="">
                    
    <a class="" href="../../../publish/crontab/">How to automate running your tool?</a>
                </li>
                <li class="">
                    
    <a class="" href="../../../publish/update-scripts/">How make updating your tool easy?</a>
                </li>
                <li class="">
                    
    <a class="" href="../../../publish/sign-off/">Who can sign off on tests, reviews and deploys?</a>
                </li>
                <li class="">
                    
    <a class="" href="../../../publish/servers/">How to update configuration?</a>
                </li>
    </ul>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">How do we use github?</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../../../github/pr/">How to make a pull request?</a>
                </li>
                <li class="">
                    
    <a class="" href="../../../github/pr-request/">How to request a pull request review?</a>
                </li>
                <li class="">
                    
    <a class="" href="../../../github/pr-etiquette/">Pull request etiquette</a>
                </li>
    </ul>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">Other recommendations?</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../../../perl/">What if I need perl?</a>
                </li>
                <li class="">
                    
    <a class="" href="../../../perl/best_practises/best_practises/">What are perl's best practices?</a>
                </li>
    </ul>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../../../mkdocs/">How do I publish this manual?</a>
	    </li>
          
        </ul>
      </div>
      &nbsp;
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="../../..">Development manual</a>
      </nav>

      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../../..">Docs</a> &raquo;</li>
    
      
        
          <li>How to write unit tests? &raquo;</li>
        
      
        
          <li>How do we use Python? &raquo;</li>
        
      
    
    <li>Are you using fixtures?</li>
    <li class="wy-breadcrumbs-aside">
      
        <a href="https://github.com/Clinical-Genomics/development/edit/master/docs/python/testing/fixtures.md"
          class="icon icon-github"> Edit on GitHub</a>
      
    </li>
  </ul>
  <hr/>
</div>
          <div role="main">
            <div class="section">
              
                <h1 id="fixtures-and-pytest">Fixtures (and pytest)</h1>
<p>Python has a number of test runners to extend and simplify writing (unit) tests. We recommend <a href="http://docs.pytest.org/en/latest/">pytest</a>: a super robust and feature rich test framework. It lets you write tests as simple “asserts“, has a brilliant plugin ecosystem that “just works” after pip install pytest-[somePlugin], and let’s you leverage powerful fixtures to keep things DRY.</p>
<p>A small flavor of what tests look like with pytest:</p>
<pre><code>import pytest
from mypackage import best_movie, perform_division

def test_best_movie():
    movie = best_movie(director='P.T. Anderson')
    assert movie == 'There Will Be Blood'

def test_perform_division():
    with pytest.raises(ValueError):
        # call with parameters that should yield error
        perform_division(12, 0)
</code></pre>

<p>Running your tests is as easy as:</p>
<pre><code>$ py.test --verbose
</code></pre>

<h2 id="organizing-tests">Organizing tests</h2>
<p>pytest does a great job of detecting tests. All you need to do is name test modules with a prefix: <code>test_*</code>. Each test function should similarly be named <code>def test_*:</code>.</p>
<p>Furthermore, organize test files to reflect the source code. The following package:</p>
<pre><code>myPackage
|-- utils.py
|-- tools
     |-- docker.py
</code></pre>

<p>… would result in the following test structure:</p>
<pre><code>tests
|-- test_utils.py
|-- tools
     |-- test_tools_docker.py
</code></pre>

<p>You notice that the term “tools” is “repeating” for the “docker”-test module. This is because pytest requires globally unique test module names!</p>
<h2 id="test-fixtures">Test fixtures</h2>
<p><a href="https://docs.pytest.org/en/latest/fixture.html">Fixtures</a> is the key concept to start mastering tests. They are pluggable components that can be shared across many tests to setup pre-conditions like:</p>
<ul>
<li>setup a database connection</li>
<li>read in lines form a file</li>
</ul>
<p>They each have their own setup and tear down blocks and you control if they are reset on a function/module/session basis.</p>
<p>Let’s add a few items to our setup:</p>
<pre><code>tests
|-- fixtures                    # store static files here
|-- test_utils.py
|-- tools
     |-- test_tools_docker.py
|-- conftest.py                 # write fixture functions here
</code></pre>

<p>Inside conftest.py you can add fixture functions that will be exposed to your tests. You mark a function as a fixture with a decorator. If you don’t need setup/tear down you can use a simple <code>@pytest.fixture</code>. Otherwise it's easiest to use <code>@pytest.yield_fixture</code>.</p>
<pre><code># conftest.py
import pytest
from myPackage import DatabaseAPI

@pytest.yield_fixture(scope='function')
def db_connection():
    _db_connection = DatabaseAPI(uri=':memory:')
    _db_connection.create_tables()
    yield _db_connection
    _db_connection.teardown_tables()
</code></pre>

<pre><code># test_utils.py
def test_add_row(db_connection):
    name = 'Paul T. Anderson'
    add_row(name=name, age=34)
    db_connection.save()
    assert db_connection.get_row(name=name).age == 34
</code></pre>

<p>When pytest runs the above function it will look for a fixture called <code>db_connection</code> and run it. Whatever is yielded (or returned) will be passed along to the test function. We set the “scope” of the fixture to “function” so as soon as the test is complete, the block after the yield statement will run. You can pass as many fixtures as you want to a test.</p>
<blockquote>
<p>Tip: test fixtures accept parameter-dependencies the same way as test functions. It’s perfectly possible to combine several test fixtures.</p>
</blockquote>
<p>Additional fixtures can be installed through plugins and pytest itself comes with a few built in. For example there’s the handy tmpdir fixture that provides unique temporary folders where you can test various side effects.</p>
<pre><code>from mypackage import touch

def test_write_file(tmpdir):
    # GIVEN an empty dir
    assert len(tmpdir.listdir()) == 0
    # WHEN touching a new file
    new_path = tmpdir.join('newfile.txt')
    touch(str(new_path))
    # THEN there should be a new file created
    assert len(tmpdir.listdir()) == 1
</code></pre>
              
            </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../../../publish/prod/" class="btn btn-neutral float-right" title="How to publish your tool?">Next <span class="icon icon-circle-arrow-right"></span></a>
      
      
        <a href="../" class="btn btn-neutral" title="GIVEN-WHEN-THEN"><span class="icon icon-circle-arrow-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
    
  </div>

  Built with <a href="http://www.mkdocs.org">MkDocs</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
      
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" style="cursor: pointer">
    <span class="rst-current-version" data-toggle="rst-current-version">
      
          <a href="https://github.com/Clinical-Genomics/development/" class="fa fa-github" style="float: left; color: #fcfcfc"> GitHub</a>
      
      
        <span><a href="../" style="color: #fcfcfc;">&laquo; Previous</a></span>
      
      
        <span style="margin-left: 15px"><a href="../../../publish/prod/" style="color: #fcfcfc">Next &raquo;</a></span>
      
    </span>
</div>
    <script>var base_url = '../../..';</script>
    <script src="../../../js/theme.js" defer></script>
      <script src="../../../search/main.js" defer></script>

</body>
</html>
